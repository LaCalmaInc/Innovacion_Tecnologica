<!DOCTYPE html>
<!-- saved from url=(0050)https://casino.usm.cl/solicitud/MisSolicitudesMenu -->
<html>
    <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="./MisReservas_files/bootstrap.min.css">
        <link href="./MisReservas_files/estilo.css" rel="stylesheet" type="text/css">
        <link href="./MisReservas_files/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css">
        <link href="./MisReservas_files/daterangepicker.css" rel="stylesheet" type="text/css">
        <link href="./MisReservas_files/all.css" rel="stylesheet" type="text/css">
        <link href="./MisReservas_files/datatables.min.css" rel="stylesheet" type="text/css">
        <link href="./MisReservas_files/select2.min.css" rel="stylesheet" type="text/css">
        <title>Casino de Alimentación</title>
        <style>
            label i {
                display: none !important;
            }
            label:hover i {
                display: inline-block !important;
            }
            label i:hover{
                cursor: help
            }
            table.dataTable thead th, table.dataTable thead td{
                     border-bottom: 0px ;
                
            }
        </style>
    <style type="text/css" id="operaUserStyle"></style>
    </head>
    <script>
  window.addEventListener("DOMContentLoaded", () => {
    const name = localStorage.getItem("userName");
    if (!name) {
      // si no hay sesión activa
      window.location.href = "login.html";
      return;
    }
    // Actualizar TODOS los spans de usuario
    document
      .querySelectorAll(".link-top-bar.single-link.external")
      .forEach(el => el.textContent = name);
  });
</script>
    <body class="body-usm">   
        <a  style="display: none" id="volver">aqui</a>
               



<link rel="stylesheet" href="./MisReservas_files/normalize.css">
<link rel="stylesheet" href="./MisReservas_files/usm-estilo.css">
<link href="./MisReservas_files/css2" rel="stylesheet">
<header id="header" class="container-fluid">
    <div class="row top-bar">
        <div class="container">
            <div class="row justify-content-between">
                <div class="col-4 ocultar-mobile">
                    <ul class="breadcrumbs">
                        <li>
                            <a > USM.cl</a>
                        </li>
                    </ul>
                </div>
                <div class="col-sm-12 col-md-8 text-right">
                    <ul class="top-bar-menu">
                        <li class="nav-item dropdown   usm-menus ">
                            <a class="nav-link dropdown-toggle link-top-bar"  data-toggle="dropdown" id="dp-categorias2" aria-expanded="false">Minuta</a>
                            <ul class="dropdown-menu fade-up" aria-labelledby="dp-categorias2" >                    
                                <li><a target="_blank" class="dropdown-item">Casa Central Valparaíso</a></li>
                                <li><a target="_blank" class="dropdown-item">Vitacura</a></li>
                                <li><a target="_blank" class="dropdown-item">Vińa del Mar</a></li>
                                <li><a target="_blank" class="dropdown-item">Concepción</a></li>
                                <li><a target="_blank" class="dropdown-item">San Joaquín</a></li>
                            </ul>
                        </li>
                        
                        <li>
                            <span class="link-top-bar single-link external">Usuario</span>
                        </li>
                        <li>
                            <a class="link-top-bar single-link" href="Homepage.html">Cerrar sesión</a>
                        </li>              
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row wrap-menu">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-md-3 logo-usm">
                    <a [routerlink]="[&#39;/&#39;]" class="brand-link">
                        <img src="./MisReservas_files/logo-usm.svg" alt="Universidad Técnica Federico Santa María">
                    </a>
                </div>
                <div class="col-md-3 text-right">
                </div>
            </div>
        </div>
    </div>
    <div class="row wrap-menu-mobile">
        <div class="container">
            <div class="row justify-content-between align-items-center" style="padding-left: .65rem">
                <div class="col-6 col-sm-6 col-md-5 col-lg-4">
                    <a [routerlink]="[&#39;/&#39;]" class="brand-link">
                        <img src="./MisReservas_files/logo-usm.svg" alt="Universidad Técnica Federico Santa María">
                    </a>
               </div>
                <div class="col-4 col-md-3 col-sm-6 text-right">
                    <a  class="wrap-icon-menu toggle-menu">
                        <i class="fas fa-bars"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="container-fluid wrap-items-menu-mobile" style="display: block;">
            <div class="row" id="collapseMain">
                <div class="navbar-menu-mobile blue-menu" style="padding-left: .65rem">
                    
                    <a href="ReservaDeMenu.html" class="item-navbar-mobile">Reserva de menú</a>
                    <a href="MisReservas.html" class="item-navbar-mobile">Mis reservas</a>
                    <a href="MisConsumos.html" class="item-navbar-mobile">Mis consumos</a>
                    <a href="ComprarAlmuerzos.html" class="item-navbar-mobile">Comprar almuerzos</a>
                    <a href="ProgramacionMenu.html" class="item-navbar-mobile">Programación Menú</a>
                    <a href="CajaComentarios.html" class="item-navbar-mobile">Caja de Comentarios</a>
                    <a id="linkVisualizacionesMobile" href="Visualizaciones.html" class="item-navbar-mobile">Visualizaciones</a>
                    
                    
                <div class="wrap-collapse-mobile">
                    <a  class="item-navbar-mobile collapsed" data-toggle="collapse" aria-controls="collapseColacion" aria-expanded="false">Minuta<i class="fas fa-angle-down"></i></a>
                        <div class="collapse-items-mobile collapse" id="collapseMinuta" data-parent="#collapseMain" style="">      
                            <div class="navbar-menu-mobile">                 
                                <a  target="_blank" class="item-navbar-mobile">Casa Central Valparaíso</a>
                                <a  target="_blank" class="item-navbar-mobile">Vitacura</a>
                                <a target="_blank" class="item-navbar-mobile">Vińa del Mar</a>
                                <a target="_blank" class="item-navbar-mobile">Concepción</a>
                                <a target="_blank" class="item-navbar-mobile">San Joaquín</a>
                            </div>
                        </div>    
                    
                </div>

                 
                </div>
            </div>
        </div>
    </div>
</header>
<div class="container">
    
    <div class="form-group row justify-content-center mt-3 text-center">
        <div class="col">
            
            <main>
                <ul class="nav nav-tabs tabs-superior ocultar-tab-mobile" id="tabs-superior ">
                    
                    <li class="nav-item">
                        <a href="ReservaDeMenu.html" class="nav-link ">Reserva de menú</a>  
                    </li>
                    <li class="nav-item">
                        <a href="MisReservas.html" class="nav-link">Mis reservas</a>
                    </li>
                    <li class="nav-item">
                        <a href="MisConsumos.html" class="nav-link ">Mis consumos</a>
                    </li>
                    <li class="nav-item">
                        <a href="ComprarAlmuerzos.html" class="nav-link ">Comprar almuerzos</a>
                    </li>
                    <li class="nav-item">
                        <a href="ProgramacionMenu.html" class="nav-link active">Programación Menú</a>
                    </li>
                    <li class="nav-item">
                        <a href="CajaComentarios.html" class="nav-link">Caja de Comentarios</a>
                    </li>
                    <li class="nav-item">
                        <a id="linkVisualizacionesDesktop" href="Visualizaciones.html" class="nav-link">Visualizaciones</a>
                    </li>
                </ul>
            </main>
        <div class="">
            <div class="card">
              <!--  <div class="card-header">
                    <h2 class="titulo">
                        <small class="text-center">                            
                            Anulación de almuerzo           
                        </small>
                    </h2>
                </div>-->
                <div class="card-body">
                    <div id="calendario" class="mb-4"></div>

                    <!-- Modal para mostrar reseñas del día -->
                    <div class="modal fade" id="modalResenasDia" tabindex="-1" role="dialog" aria-labelledby="modalResenasDiaLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title">Reseñas del Menú del Día</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            </div>
                            <div class="modal-body">
                            <p><strong>Calificación promedio:</strong> <span id="calificacionPromedio"></span> ⭐</p>
                            <p><strong>Plato del día:</strong> <span id="platoDelDia"></span></p>
                            <hr>
                            <div id="listaResenas"></div>
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css">
                    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                        const calendarEl = document.getElementById('calendario');
                        const calendar = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth',
                            locale: 'es',
                            firstDay: 1,
                            headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: ''
                            },
                            events: generarEventosDeMenus(),
                            eventClick: function(info) {
                            if (info.event.extendedProps.resenas) {
                                mostrarModalResenas(info.event);
                            }
                            }
                        });
                        calendar.render();
                        });

                        function generarEventosDeMenus() {
                        const hoy = new Date();
                        const eventos = [];
                        const platos = [
                            'Pastel de choclo',
                            'Lasaña de carne',
                            'Porotos con riendas',
                            'Arroz con pollo',
                            'Carbonada',
                            'Fideos a la boloñesa',
                            'Cazuela de vacuno',
                            'Empanadas con ensalada',
                            'Pollo al jugo con arroz',
                            'Ensalada César con pollo'
                        ];
                        for (let i = -50; i <= 10; i++) {
                            const fecha = new Date(hoy);
                            fecha.setDate(hoy.getDate() + i);
                            const fechaStr = fecha.toISOString().split('T')[0];
                            const plato = platos[Math.floor(Math.random() * platos.length)];

                            if (i <= 0) {
                            // Menús pasados o de hoy con calificación y reseñas
                            const calificacion = Math.floor(Math.random() * 5) + 1;
                            eventos.push({
                                title: `⭐ ${calificacion} - ${plato}`,
                                start: fechaStr,
                                extendedProps: {
                                calificacion,
                                plato,
                                resenas: generarResenasFalsas()
                                }
                            });
                            } else {
                            // Menús futuros solo muestran el plato
                            eventos.push({
                                title: `${plato}`,
                                start: fechaStr,
                                extendedProps: {
                                plato
                                }
                            });
                            }
                        }
                        return eventos;
                        }

                        function generarResenasFalsas() {
                        const comentarios = [
                            'Lorem ipsum dolor sit amet.',
                            'Muy rico y bien preparado.',
                            'El arroz estaba un poco duro.',
                            'Excelente atención y menú.',
                            'No fue de mi agrado.'
                        ];
                        const resenas = [];
                        const cantidad = Math.floor(Math.random() * 5) + 1;
                        for (let i = 0; i < cantidad; i++) {
                            resenas.push({
                            estrellas: Math.floor(Math.random() * 5) + 1,
                            comentario: comentarios[Math.floor(Math.random() * comentarios.length)]
                            });
                        }
                        return resenas;
                        }

                        function mostrarModalResenas(evento) {
                        document.getElementById('calificacionPromedio').textContent = evento.extendedProps.calificacion;
                        document.getElementById('platoDelDia').textContent = evento.extendedProps.plato;
                        const contenedor = document.getElementById('listaResenas');
                        contenedor.innerHTML = '';
                        evento.extendedProps.resenas.forEach(resena => {
                            const div = document.createElement('div');
                            div.innerHTML = `<p>⭐ ${resena.estrellas}<br><em>${resena.comentario}</em></p><hr>`;
                            contenedor.appendChild(div);
                        });
                        $('#modalResenasDia').modal('show');
                        }
                    </script>
                </div>

     
            </div>
        </div>
        <div class="modal fade" data-keyboard="false" data-backdrop="static" id="informacionBloqueadaGeneral" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="TitleInformcacionBloqueadaGeneral">Modal title</h5>
                    </div>
                    <div class="modal-body" id="contenidoInformacionBloqueadaGeneral">

                    </div>
                    <div class="modal-footer" id="footerInformacionBloqueadaGeneral">

                    </div>
                </div> 
            </div>
        </div>
        
        <div class="modal fade" id="informaModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="informaModalTitle">Informacion</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div id="informaModalBody" class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-usm" data-dismiss="modal">Aceptar</button>                
                    </div>
                </div>
            </div>
        </div>
        
                   </div>
         </div>
         
         <!-- container -->
        <div class="modal fade" id="informaModalG" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="informaModalTitleG">Información</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div id="informaModalBodyG" class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-usm" data-dismiss="modal">Aceptar</button>                
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" data-keyboard="false" data-backdrop="static" id="informacionBloqueadaGeneralG" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="TitleInformcacionBloqueadaGeneralG">Modal title</h5>
                    </div>
                    <div class="modal-body" id="contenidoInformacionBloqueadaGeneralG">

                    </div>
                    <div class="modal-footer" id="footerInformacionBloqueadaGeneralG">

                    </div>
                </div> 
            </div>
        </div>
        <div id="modalCargarG" class="modal fade" data-keyboard="false" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document" style="background: none">
              <div class="modal-content " style="width: 400px; height: 400px; background: none; border: none;">
                <div class="modal-body" style="padding-top: 100px; background: none;">
                    <div class="fa-7x">
                        <i style="color: #004b85" class="fas fa-sync fa-spin">
                        </i>
                   </div>
                </div>
              </div>
            </div>
        </div>
    <footer id="footer" class="container-fluid footer-interno">
    
    <div class="row footer3 fixed-bottom">
        <div class="container">
             <p class="small fixed-p">Sitio web administrado por <a [routerlink]="[&#39;/&#39;]" class="link-white-footer external admin-titulo">Dirección General de Sistemas de Gestión</a></p>
             <!--<p class="small">Sitio web administrado por la <a href="https://usm.cl/" target="_blank" class="link-white-footer external admin-titulo">Dirección ERP</a></p>-->
        </div>
    </div>
    </footer>
        <script src="./MisReservas_files/jquery-3.5.1.min.js.descarga"></script>
        <script src="./MisReservas_files/bootstrap.bundle.min.js.descarga"></script>
        <script src="./MisReservas_files/bootstrap.min.js.descarga"></script>
        <script src="./MisReservas_files/menu.js.descarga"></script>
        <script>
            window.addEventListener("DOMContentLoaded", () => {
                const role = localStorage.getItem("userRole");
                // Si no es administrador, ocultamos la pestaña Visualizaciones
                if (role !== "admin") {
                const desktopLink = document.getElementById("linkVisualizacionesDesktop");
                const mobileLink  = document.getElementById("linkVisualizacionesMobile");
                if (desktopLink) desktopLink.style.display = "none";
                if (mobileLink)  mobileLink.style.display = "none";
                }
            });
        </script>
        <script type="text/javascript">
        function modalCargandoAbrirG(){
            $("#modalCargarG").modal("show");    
        }
        function modalCargandoCloseG(){
            $("#modalCargarG").modal("hide");    
        }
        function informaModal(titulo,mensaje){
          $("#informaModalTitleG").html(titulo);
          $("#informaModalBodyG").html(mensaje);
          if (!$("#informaModalG").hasClass("show")) {
              $("#informaModalG").modal("show");
          }
        }          
        function abrirModalBloqueadaGeneral(TituloModal, htmlForContent, htmlFooter) {
            $("#footerInformacionBloqueadaGeneralG").html("");
            $("#TitleInformcacionBloqueadaGeneralG").html("");
            $("#TitleInformcacionBloqueadaGeneralG").append(TituloModal);
            $("#contenidoInformacionBloqueadaGeneralG").html("")
            $("#contenidoInformacionBloqueadaGeneralG").append(htmlForContent);
            $("#footerInformacionBloqueadaGeneralG").html(htmlFooter);
            if (!$("#informacionBloqueadaGeneralG").hasClass("show")) {
                $("#informacionBloqueadaGeneralG").modal("show");
            }            
        }
        function cerrarModalBloqueadaGeneral() {
            
            if ($("#informacionBloqueadaGeneralG").hasClass("show")) {
                $("#informacionBloqueadaGeneralG").modal("hide");
            }            
        }
        function consultaAjaxeJson(url,propiedades,personalFuction,functionError){
                //console.log("hola 1");
                //console.log(propiedades);
                if(functionError==undefined){
                functionError=function(){};
            }
                jQuery.ajax({
                'type': 'POST',
                'url': url,
                //'contentType': 'application/x-www-form-urlencoded',
                'data': propiedades,
                        'dataType': 'text',
                        success: function(rest){
                                //console.log(rest);
                                personalFuction(rest);
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                                console.log("consultaAjaxeJson: error");
                                functionError();
                          alert(xhr.status);
                          alert(thrownError);
                        },timeout: 300000 
            });
        }
        </script>
       
        <script src="./MisReservas_files/moment.js.descarga" type="text/javascript"></script>
        <script src="./MisReservas_files/bootstrap-datepicker.js.descarga" type="text/javascript"></script>
        <script src="./MisReservas_files/daterangepicker.js.descarga" type="text/javascript"></script>        
        <script src="./MisReservas_files/datatables.min.js.descarga" type="text/javascript"></script>
        <script src="./MisReservas_files/select2.min.js.descarga" type="text/javascript"></script>
        
        <script type="text/javascript">
            
                function anularDetalle(iddetalle){
                    
                   var id = iddetalle;
                   var url ="/solicitud/ConsultasSensillas";
                   var propi ={
                       opcion:9,
                       iddetalle:id
                   };
                   cerrarModalBloqueadaGeneral();
                   consultaAjaxeJson(url, propi, function(data){
                       //console.log("data: " + data);
                       var obj = JSON.parse(data);
                       //console.log(obj);
                       if (data.anulacion == -1){
                            informaModal("Información","No fue posible anular la reserva, favor volver a intentar. ");
                            return;
                       } else {
                       modalCargandoAbrirG();
                       setTimeout(function(){modalCargandoCloseG()},500)
                       tableG.rows().remove().draw();
                       tableG.rows.add(obj.fechas).draw();
                       if (obj.cambio=='C'){
                            informaModal("Información","Reserva anulada a partir del "+ obj.fechaMensaje +".");
                       } else {
                            informaModal("Información","Reserva anulada correctamente.");
                       }
                       }}, function(error){
                            console.log(error);
                   });
                } 
                $(document).on("click",".anular",function(){
                    var id = $(this).data("key");
                    var footer = '<input type="button" class="btn btn-usm" value="Si" onclick="anularDetalle('+id+')" /><input class="btn btn-usm" type="button" value="No" onclick="cerrarModalBloqueadaGeneral()"/>';
                    abrirModalBloqueadaGeneral("Información","¿Está seguro de anular la reserva seleccionada?",footer);
                    
                });
                var tableG= $("#fechas").DataTable({
                            "language": {
                                "info": " ",
                                "emptyTable": "No existen solicitudes",
                                "infoEmpty": ""
                            },data:[] ,
                            "drawCallback": function( settings ) {
                               //$("#turno").trigger("change");
                           },
                            createdRow: function (row, data, dataIndex) {                               

                            },
                            columns: [{
                                    render: function (data, type, row, meta) {
                                        var disable ="";
                                        if(row.deshab=="true"){
                                            disable = 'disabled="true" style="cursor: no-drop;"';
                                        }
                                        return '<input type="button" '+disable+' class="btn btn-usm anular" value="Anular" data-key="'+row.codDet+'" />';
                                    }
                                },{
                                    render: function (data, type, row, meta) {

                                        return row.registro;
                                    }
                                },{
                                    render: function (data, type, row, meta) {

                                        return row.codDet;
                                    }
                                },{
                                    render: function (data, type, row, meta) {

                                        return row.desde;
                                    }
                                },{
                                    render: function (data, type, row, meta) {

                                        return row.hasta;
                                    }
                                },{
                                    render: function (data, type, row, meta) {

                                        return row.menu;
                                    }
                                },{
                                    render: function (data, type, row, meta) {

                                        return row.sede;
                                    }
                                }
                            ],

                            paging: false,
                            "searching": false,
                            "order": [[ 2, "desc" ]],
                            responsive: true
                    });
        </script>
    

</body></html>